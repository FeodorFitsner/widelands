#!/usr/bin/python


"""
This catches a closing brace followed by a character that is not withing the
[^] list. it catches code like "struct {T x}a;", which should be "struct {T x}
a;". Characters after // are ignored.
"""


regexp=r"""(?x)
^( 
    (?!\#)
    (?!.*//)  # No c++ comment
    (?!.*/\*) # No c comment
    (?!.*(".*[^\\]"))   # No string "llala"\n
    .*      # Otherwise match everything
)
\}  [^ ,;})\"\\] # Match the } and finally the illegal characters
"""

error_msg = "Illegal character after closing brace"""

forbidden = [
    r'struct {T x;}a;',
    r'"\\"}a;',
    r"\''}a;",
]

allowed = [
    r'}'+'\\',
    r'("expected [on failure {fail|repeat|ignore}] but found \"%s\""',
    
    '#macro blahblh }\\',
    r'	"   a:link    {text-decoration:none;}\n"',
    r'#define }hello',
    r'struct {T x;} a;',
    r'namespace A {struct B;};}',
    r'//}a',
    r'///}a',
    r'// {a|b}c',
    r"char a[][3] = {{'a', 'b', 'c'}, {'d', 'e', 'f'}, {'g', 'h', 'i'}}",
    r'"{a, b, c}"',
    r'"\"})"',
    r'"\"})" and even "\"})"',
    r'''("illegal state \"%s\" (must be one of {init, running, done)}",''',
    r'''("illegal state \"%s\" (must be one of {init, running, done})",''', # Spot the difference ;)
]

